{% extends 'base.html' %}

{% block dashboard_active %}active{% endblock %}

{% block title %}MediDash - Consolidated Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
  #map {
    height: 400px;
    width: 100%;
    border-radius: 5px;
  }

  .marker-pin {
    border-radius: 50%;
    width: 20px;
    height: 20px;
    border: 2px solid #fff;
    text-align: center;
    line-height: 20px;
    font-weight: bold;
    color: white;
  }

  .marker-high {
    background-color: #dc3545;
  }

  .marker-medium {
    background-color: #ffc107;
  }

  .marker-low {
    background-color: #28a745;
  }

  .legend {
    background: white;
    padding: 10px;
    border-radius: 5px;
    line-height: 24px;
    color: #333;
  }

  .legend i {
    width: 20px;
    height: 20px;
    float: left;
    margin-right: 8px;
    opacity: 0.8;
    border-radius: 50%;
  }

  .chart-container {
    height: 300px;
  }

  .metric-card {
    transition: transform 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Consolidated Dashboard</h5>
      </div>
      <div class="card-body">
        <p class="mb-3">This dashboard provides a map view and query graphs for health data analysis.</p>
      </div>
    </div>
  </div>
</div>

<!-- Interactive Map Row -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Disease Risk Map</h5>
      </div>
      <div class="card-body">
        <div id="map"></div>
        <div class="mt-3">
          <div class="d-flex justify-content-center">
            <div class="px-2"><span class="badge bg-success">&nbsp;</span> Low Risk</div>
            <div class="px-2"><span class="badge bg-warning">&nbsp;</span> Medium Risk</div>
            <div class="px-2"><span class="badge bg-danger">&nbsp;</span> High Risk</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Query Graphs Row -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5>Disease Severity Distribution</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="severityChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5>Risk Level Distribution</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Queries Section -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Queries</h5>
      </div>
      <div class="card-body">
        <!-- Tabs for different query types -->
        <ul class="nav nav-tabs" id="queryTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="people-tab" data-bs-toggle="tab" data-bs-target="#people" type="button" role="tab" aria-controls="people" aria-selected="true">
              <i class="fas fa-users"></i> People
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="diseases-tab" data-bs-toggle="tab" data-bs-target="#diseases" type="button" role="tab" aria-controls="diseases" aria-selected="false">
              <i class="fas fa-virus"></i> Diseases
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="health-records-tab" data-bs-toggle="tab" data-bs-target="#health-records" type="button" role="tab" aria-controls="health-records" aria-selected="false">
              <i class="fas fa-notes-medical"></i> Health Records
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="demographics-tab" data-bs-toggle="tab" data-bs-target="#demographics" type="button" role="tab" aria-controls="demographics" aria-selected="false">
              <i class="fas fa-chart-pie"></i> Demographics
            </button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content mt-3" id="queryTabsContent">
          <!-- People Queries Tab -->
          <div class="tab-pane fade show active" id="people" role="tabpanel" aria-labelledby="people-tab">
            <div class="row">
              <div class="col-md-12">
                {% if people_queries.query_title %}
                <h4>{{ people_queries.query_title }}</h4>
                <hr>

                {% if people_queries.error %}
                <div class="alert alert-danger">{{ people_queries.error }}</div>
                {% endif %}

                {% if people_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="peopleQueryChart"></canvas>
                </div>
                {% endif %}

                {% if people_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in people_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in people_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Diseases Queries Tab -->
          <div class="tab-pane fade" id="diseases" role="tabpanel" aria-labelledby="diseases-tab">
            <div class="row">
              <div class="col-md-12">
                {% if disease_queries.query_title %}
                <h4>{{ disease_queries.query_title }}</h4>
                <hr>

                {% if disease_queries.error %}
                <div class="alert alert-danger">{{ disease_queries.error }}</div>
                {% endif %}

                {% if disease_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="diseaseQueryChart"></canvas>
                </div>
                {% endif %}

                {% if disease_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in disease_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in disease_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Health Records Queries Tab -->
          <div class="tab-pane fade" id="health-records" role="tabpanel" aria-labelledby="health-records-tab">
            <div class="row">
              <div class="col-md-12">
                {% if health_record_queries.query_title %}
                <h4>{{ health_record_queries.query_title }}</h4>
                <hr>

                {% if health_record_queries.error %}
                <div class="alert alert-danger">{{ health_record_queries.error }}</div>
                {% endif %}

                {% if health_record_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="healthRecordQueryChart"></canvas>
                </div>
                {% endif %}

                {% if health_record_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in health_record_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in health_record_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Demographics Queries Tab -->
          <div class="tab-pane fade" id="demographics" role="tabpanel" aria-labelledby="demographics-tab">
            <div class="row">
              <div class="col-md-12">
                {% if demographic_queries.query_title %}
                <h4>{{ demographic_queries.query_title }}</h4>
                <hr>

                {% if demographic_queries.error %}
                <div class="alert alert-danger">{{ demographic_queries.error }}</div>
                {% endif %}

                {% if demographic_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="demographicQueryChart"></canvas>
                </div>
                {% endif %}

                {% if demographic_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in demographic_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in demographic_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize the map
    initMap();

    // Create charts
    createSeverityChart();
    createRiskChart();

    // Initialize query charts if they exist
    initQueryCharts();

    // Activate the appropriate tab based on the section parameter
    activateTabFromUrl();
  });

  function activateTabFromUrl() {
    // Get the section parameter from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const section = urlParams.get('section');

    // If a section is specified, activate the corresponding tab
    if (section) {
      const tabId = section === 'health-records' ? 'health-records-tab' : `${section}-tab`;
      const tab = document.getElementById(tabId);
      if (tab) {
        const tabTrigger = new bootstrap.Tab(tab);
        tabTrigger.show();
      }
    }
  }

  function initMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;

    // Create the map
    const map = L.map('map').setView([40.7, -74.0], 10);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Create a legend
    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h6>Risk Levels</h6>
        <i class="marker-high"></i> High Risk<br>
        <i class="marker-medium"></i> Medium Risk<br>
        <i class="marker-low"></i> Low Risk
      `;
      return div;
    };

    legend.addTo(map);

    // Add location markers
    let locationData;
    try {
      locationData = JSON.parse('{{ map_data|escapejs }}');
    } catch (e) {
      // If there's an error parsing the data, use an empty array
      locationData = [];
      console.error('Error parsing map data:', e);
    }

    const markers = [];

    for (const location of locationData) {
      // Create custom marker icon based on risk level
      const markerHtml = `<div class="marker-pin marker-${location.risk_level}"></div>`;
      const customIcon = L.divIcon({
        html: markerHtml,
        iconSize: [20, 20],
        className: ''
      });

      // Create marker and popup
      const marker = L.marker([location.lat, location.lon], { icon: customIcon }).addTo(map);
      marker.bindPopup(`
        <strong>${location.name}</strong><br>
        Case count: ${location.case_count}<br>
        Risk level: ${location.risk_level.charAt(0).toUpperCase() + location.risk_level.slice(1)}
      `);

      markers.push(marker);
    }

    // Fit map to show all markers if any exist
    if (markers.length > 0) {
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  function createSeverityChart() {
    const ctx = document.getElementById('severityChart');
    if (!ctx) return;

    let severityData;
    try {
      severityData = JSON.parse('{{ severity_data|escapejs }}');
    } catch (e) {
      console.error('Error parsing severity data:', e);
      severityData = {
        labels: ['None', 'Mild', 'Moderate', 'Severe'],
        data: [10, 25, 40, 25]
      };
    }

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: severityData.labels,
        datasets: [{
          data: severityData.data,
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(255, 128, 0, 0.8)',
            'rgba(220, 53, 69, 0.8)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: 'Disease Severity Distribution'
          }
        }
      }
    });
  }

  function createRiskChart() {
    const ctx = document.getElementById('riskChart');
    if (!ctx) return;

    let riskData;
    try {
      riskData = JSON.parse('{{ risk_data|escapejs }}');
    } catch (e) {
      console.error('Error parsing risk data:', e);
      riskData = {
        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
        data: [45, 35, 20]
      };
    }

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: riskData.labels,
        datasets: [{
          data: riskData.data,
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(220, 53, 69, 0.8)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: 'Infection Risk Distribution'
          }
        }
      }
    });
  }

  function initQueryCharts() {
    // Initialize People Query Chart
    const peopleChartCtx = document.getElementById('peopleQueryChart');
    if (peopleChartCtx && {{ people_queries.is_chart|yesno:"true,false" }}) {
      try {
        new Chart(peopleChartCtx, {
          type: '{{ people_queries.chart_type|default:"bar" }}',
          data: {
            labels: {{ people_queries.chart_labels|safe }},
            datasets: [{
              label: '{{ people_queries.query_title }}',
              data: {{ people_queries.chart_data|safe }},
              backgroundColor: [
                'rgba(75, 192, 192, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (e) {
        console.error('Error initializing people query chart:', e);
      }
    }

    // Initialize Disease Query Chart
    const diseaseChartCtx = document.getElementById('diseaseQueryChart');
    if (diseaseChartCtx && {{ disease_queries.is_chart|yesno:"true,false" }}) {
      try {
        new Chart(diseaseChartCtx, {
          type: '{{ disease_queries.chart_type|default:"bar" }}',
          data: {
            labels: {{ disease_queries.chart_labels|safe }},
            datasets: [{
              label: '{{ disease_queries.query_title }}',
              data: {{ disease_queries.chart_data|safe }},
              backgroundColor: [
                'rgba(75, 192, 192, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (e) {
        console.error('Error initializing disease query chart:', e);
      }
    }

    // Initialize Health Record Query Chart
    const healthRecordChartCtx = document.getElementById('healthRecordQueryChart');
    if (healthRecordChartCtx && {{ health_record_queries.is_chart|yesno:"true,false" }}) {
      try {
        new Chart(healthRecordChartCtx, {
          type: '{{ health_record_queries.chart_type|default:"bar" }}',
          data: {
            labels: {{ health_record_queries.chart_labels|safe }},
            datasets: [{
              label: '{{ health_record_queries.query_title }}',
              data: {{ health_record_queries.chart_data|safe }},
              backgroundColor: [
                'rgba(75, 192, 192, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (e) {
        console.error('Error initializing health record query chart:', e);
      }
    }

    // Initialize Demographic Query Chart
    const demographicChartCtx = document.getElementById('demographicQueryChart');
    if (demographicChartCtx && {{ demographic_queries.is_chart|yesno:"true,false" }}) {
      try {
        new Chart(demographicChartCtx, {
          type: '{{ demographic_queries.chart_type|default:"bar" }}',
          data: {
            labels: {{ demographic_queries.chart_labels|safe }},
            datasets: [{
              label: '{{ demographic_queries.query_title }}',
              data: {{ demographic_queries.chart_data|safe }},
              backgroundColor: [
                'rgba(75, 192, 192, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (e) {
        console.error('Error initializing demographic query chart:', e);
      }
    }
  }
</script>
{% endblock %}
