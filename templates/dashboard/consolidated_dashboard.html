{% extends 'base.html' %}

{% block dashboard_active %}active{% endblock %}

{% block title %}MediDash - Consolidated Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
  #map {
    height: 600px;
    width: 100%;
    border-radius: 5px;
  }

  .marker-pin {
    border-radius: 50%;
    width: 20px;
    height: 20px;
    border: 2px solid #fff;
    text-align: center;
    line-height: 20px;
    font-weight: bold;
    color: white;
  }

  .marker-high {
    background-color: #dc3545;
  }

  .marker-medium {
    background-color: #ffc107;
  }

  .marker-low {
    background-color: #28a745;
  }

  .legend {
    background: white;
    padding: 10px;
    border-radius: 5px;
    line-height: 24px;
    color: #333;
  }

  .legend i {
    width: 20px;
    height: 20px;
    float: left;
    margin-right: 8px;
    opacity: 0.8;
    border-radius: 50%;
  }

  .chart-container {
    height: 300px;
  }

  .metric-card {
    transition: transform 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}

{% block content %}

<!-- Main KPI Panel -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white metric-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50">Total Cases</h6>
            <h2 class="mb-0">{{ total_records|default:"0" }}</h2>
          </div>
          <div class="fs-1">
            <i class="fas fa-clipboard-list"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="badge bg-light text-primary">
            <i class="fas fa-arrow-up"></i> 12% from last month
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white metric-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50">Active Cases</h6>
            <h2 class="mb-0">{{ active_cases|default:"0" }}</h2>
          </div>
          <div class="fs-1">
            <i class="fas fa-procedures"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="badge bg-light text-warning">
            <i class="fas fa-arrow-down"></i> 5% from last month
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white metric-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50">Recovered Cases</h6>
            <h2 class="mb-0">{{ recovered_cases|default:"0" }}</h2>
          </div>
          <div class="fs-1">
            <i class="fas fa-heart"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="badge bg-light text-success">
            <i class="fas fa-arrow-up"></i> 8% from last month
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-danger text-white metric-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-white-50">Critical Cases</h6>
            <h2 class="mb-0">{{ critical_cases|default:"0" }}</h2>
          </div>
          <div class="fs-1">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="badge bg-light text-danger">
            <i class="fas fa-arrow-down"></i> 3% from last month
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Dashboard Layout -->
<div class="row">
  <!-- Main Content Column (SecciÃ³n Principal) -->
  <div class="col-md-9">
    <!-- Row 1: Map and Temporal Trend -->
    <div class="row mb-4">
      <!-- Disease Risk Map -->
      <div class="col-md-12">
        <div class="card h-100">
          <div class="card-header">
            <h5>Disease Risk Map</h5>
          </div>
          <div class="card-body">
            <div id="map"></div>
            <div class="mt-3">
              <div class="d-flex justify-content-center">
                <div class="px-2"><span class="badge bg-success">&nbsp;</span> Low Risk</div>
                <div class="px-2"><span class="badge bg-warning">&nbsp;</span> Medium Risk</div>
                <div class="px-2"><span class="badge bg-danger">&nbsp;</span> High Risk</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Disease Type and Age Groups -->
    <div class="row mb-4">
      <!-- Disease Type Distribution (Pie Chart) -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Disease Type Distribution</h5>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-primary active"
                onclick="toggleChartType('diseaseTypeChart', 'pie')">Pie</button>
              <button type="button" class="btn btn-outline-primary"
                onclick="toggleChartType('diseaseTypeChart', 'bar')">Bar</button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="diseaseTypeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Age Group Analysis (Horizontal Bar Chart) -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5>Age Group Analysis</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="ageGroupChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Monthly Comparison and Geographic Distribution -->
    <div class="row mb-4">
      <!-- Monthly Comparison Evolution (Multiple Line Chart) -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h5>Monthly Comparison Evolution</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="monthlyComparisonChart"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Row 4: Severity Indicators (Scatter Plot) -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Severity Indicators</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="severityIndicatorsChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Column (Panel Lateral) -->
  <div class="col-md-3">
    <!-- Filter Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Filters</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="yearFilter" class="form-label">Year</label>
          <select class="form-select" id="yearFilter">
            <option value="all">All</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="monthFilter" class="form-label">Month</label>
          <select class="form-select" id="monthFilter">
            <option value="all">All</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="diseaseFilter" class="form-label">Disease</label>
          <select class="form-select" id="diseaseFilter">
            <option value="all">All</option>
            <option value="covid19">COVID-19</option>
            <option value="influenza">Influenza</option>
            <option value="dengue">Dengue</option>
          </select>
        </div>
        <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <!-- Mini Trend Charts -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Recent Trends</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <h6>Daily Cases</h6>
          <h2 class="display-4 text-primary">{{ daily_cases|default:"20" }}</h2>
        </div>
        <div class="mb-3">
          <h6>Hospitalizations</h6>
          <h2 class="display-4 text-danger">{{ hospitalizations|default:"10" }}</h2>
        </div>
        <div class="mb-3">
          <h6>Recoveries</h6>
          <h2 class="display-4 text-success">{{ recoveries|default:"18" }}</h2>
        </div>
      </div>
    </div>

    <!-- Patient State Distribution -->
    <div class="card">
      <div class="card-header">
        <h5>Patient Status</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="patientStateChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Queries Section -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Queries</h5>
      </div>
      <div class="card-body">
        <!-- Tabs for different query types -->
        <ul class="nav nav-tabs" id="queryTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="people-tab" data-bs-toggle="tab" data-bs-target="#people" type="button"
              role="tab" aria-controls="people" aria-selected="true">
              <i class="fas fa-users"></i> People
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="diseases-tab" data-bs-toggle="tab" data-bs-target="#diseases" type="button"
              role="tab" aria-controls="diseases" aria-selected="false">
              <i class="fas fa-virus"></i> Diseases
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="health-records-tab" data-bs-toggle="tab" data-bs-target="#health-records"
              type="button" role="tab" aria-controls="health-records" aria-selected="false">
              <i class="fas fa-notes-medical"></i> Health Records
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="demographics-tab" data-bs-toggle="tab" data-bs-target="#demographics"
              type="button" role="tab" aria-controls="demographics" aria-selected="false">
              <i class="fas fa-chart-pie"></i> Demographics
            </button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content mt-3" id="queryTabsContent">
          <!-- People Queries Tab -->
          <div class="tab-pane fade show active" id="people" role="tabpanel" aria-labelledby="people-tab">
            <div class="row">
              <div class="col-md-12">
                {% if people_queries.query_title %}
                <h4>{{ people_queries.query_title }}</h4>
                <hr>

                {% if people_queries.error %}
                <div class="alert alert-danger">{{ people_queries.error }}</div>
                {% endif %}

                {% if people_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="peopleQueryChart"></canvas>
                </div>
                {% endif %}

                {% if people_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in people_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in people_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Diseases Queries Tab -->
          <div class="tab-pane fade" id="diseases" role="tabpanel" aria-labelledby="diseases-tab">
            <div class="row">
              <div class="col-md-12">
                {% if disease_queries.query_title %}
                <h4>{{ disease_queries.query_title }}</h4>
                <hr>

                {% if disease_queries.error %}
                <div class="alert alert-danger">{{ disease_queries.error }}</div>
                {% endif %}

                {% if disease_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="diseaseQueryChart"></canvas>
                </div>
                {% endif %}

                {% if disease_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in disease_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in disease_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Health Records Queries Tab -->
          <div class="tab-pane fade" id="health-records" role="tabpanel" aria-labelledby="health-records-tab">
            <div class="row">
              <div class="col-md-12">
                {% if health_record_queries.query_title %}
                <h4>{{ health_record_queries.query_title }}</h4>
                <hr>

                {% if health_record_queries.error %}
                <div class="alert alert-danger">{{ health_record_queries.error }}</div>
                {% endif %}

                {% if health_record_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="healthRecordQueryChart"></canvas>
                </div>
                {% endif %}

                {% if health_record_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in health_record_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in health_record_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Demographics Queries Tab -->
          <div class="tab-pane fade" id="demographics" role="tabpanel" aria-labelledby="demographics-tab">
            <div class="row">
              <div class="col-md-12">
                {% if demographic_queries.query_title %}
                <h4>{{ demographic_queries.query_title }}</h4>
                <hr>

                {% if demographic_queries.error %}
                <div class="alert alert-danger">{{ demographic_queries.error }}</div>
                {% endif %}

                {% if demographic_queries.is_chart %}
                <div class="chart-container" style="position: relative; height:400px;">
                  <canvas id="demographicQueryChart"></canvas>
                </div>
                {% endif %}

                {% if demographic_queries.query_results %}
                <div class="table-responsive mt-4">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        {% for key in demographic_queries.query_results.0.keys %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in demographic_queries.query_results %}
                      <tr>
                        {% for value in item.values %}
                        <td>{{ value }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                  <h4>No Data Available</h4>
                  <p>There is no data available for this query.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize the map
    initMap();

    // Initialize all dashboard charts
    initDashboardCharts();

    // Initialize mini charts in sidebar
    initMiniCharts();

    // Initialize patient state chart
    createPatientStateChart();

    // Initialize query charts if they exist
    initQueryCharts();

    // Activate the appropriate tab based on the section parameter
    activateTabFromUrl();
  });

  function activateTabFromUrl() {
    // Get the section parameter from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const section = urlParams.get('section');

    // If a section is specified, activate the corresponding tab
    if (section) {
      const tabId = section === 'health-records' ? 'health-records-tab' : `${section}-tab`;
      const tab = document.getElementById(tabId);
      if (tab) {
        const tabTrigger = new bootstrap.Tab(tab);
        tabTrigger.show();
      }
    }
  }

  function initMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;

    // Create the map with a global view
    const map = L.map('map').setView([20, 0], 2);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Create a legend
    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h6>Risk Levels</h6>
        <i class="marker-high"></i> High Risk<br>
        <i class="marker-medium"></i> Medium Risk<br>
        <i class="marker-low"></i> Low Risk
      `;
      return div;
    };

    legend.addTo(map);

    // Add location markers
    let locationData;
    try {
      locationData = JSON.parse('{{ map_data|escapejs }}');
    } catch (e) {
      // If there's an error parsing the data, use an empty array
      locationData = [];
      console.error('Error parsing map data:', e);
    }

    const markers = [];

    for (const location of locationData) {
      // Create custom marker icon based on risk level
      const markerHtml = `<div class="marker-pin marker-${location.risk_level}"></div>`;
      const customIcon = L.divIcon({
        html: markerHtml,
        iconSize: [20, 20],
        className: ''
      });

      // Create marker and popup
      const marker = L.marker([location.lat, location.lon], { icon: customIcon }).addTo(map);
      marker.bindPopup(`
        <strong>${location.name}</strong><br>
        Case count: ${location.case_count}<br>
        Risk level: ${location.risk_level.charAt(0).toUpperCase() + location.risk_level.slice(1)}
      `);

      markers.push(marker);
    }

    // Fit map to show all markers if any exist
    if (markers.length > 0) {
      const group = new L.featureGroup(markers);
      // Use a larger padding for global data to ensure all markers are visible
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }

  function initDashboardCharts() {
    // Create all main dashboard charts
    createDiseaseTypeChart();
    createAgeGroupChart();
    createMonthlyComparisonChart();
    createSeverityIndicatorsChart();
  }

  function createDiseaseTypeChart() {
    const ctx = document.getElementById('diseaseTypeChart');
    if (!ctx) return;

    // Sample data for disease types
    const diseaseTypes = ['Respiratory', 'Cardiovascular', 'Gastrointestinal', 'Neurological', 'Other'];
    const caseCounts = [300, 150, 100, 80, 50];

    window.diseaseTypeChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: diseaseTypes,
        datasets: [{
          data: caseCounts,
          backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right'
          },
          title: {
            display: true,
            text: 'Disease Type Distribution'
          }
        }
      }
    });
  }

  function createAgeGroupChart() {
    const ctx = document.getElementById('ageGroupChart');
    if (!ctx) return;

    // Sample data for age groups
    const ageGroups = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70+'];
    const maleCounts = [20, 30, 40, 50, 45, 35, 25, 15];
    const femaleCounts = [25, 35, 45, 55, 50, 40, 30, 20];

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ageGroups,
        datasets: [
          {
            label: 'Male',
            data: maleCounts,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Female',
            data: femaleCounts,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Cases by Age Group and Gender'
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Cases'
            }
          }
        }
      }
    });
  }

  function createMonthlyComparisonChart() {
    const ctx = document.getElementById('monthlyComparisonChart');
    if (!ctx) return;

    // Sample data for monthly comparison
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const year2023 = [65, 59, 80, 81, 56, 55];
    const year2024 = [28, 48, 40, 19, 86, 27];
    const year2025 = [90, 120, 160, 190, 210, 250];

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: '2023',
            data: year2023,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 4
          },
          {
            label: '2024',
            data: year2024,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 4
          },
          {
            label: '2025',
            data: year2025,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Case Comparison by Year'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Cases'
            }
          }
        }
      }
    });
  }


  function createSeverityIndicatorsChart() {
    const ctx = document.getElementById('severityIndicatorsChart');
    if (!ctx) return;

    // Generate random scatter data
    const generateScatterData = (count, xMin, xMax, yMin, yMax) => {
      const data = [];
      for (let i = 0; i < count; i++) {
        data.push({
          x: Math.random() * (xMax - xMin) + xMin,
          y: Math.random() * (yMax - yMin) + yMin,
          r: Math.random() * 10 + 5 // Random radius between 5 and 15
        });
      }
      return data;
    };

    // Sample data for severity indicators
    const lowSeverity = generateScatterData(20, 0, 100, 0, 30);
    const mediumSeverity = generateScatterData(15, 20, 120, 30, 60);
    const highSeverity = generateScatterData(10, 40, 140, 60, 100);

    new Chart(ctx, {
      type: 'bubble',
      data: {
        datasets: [
          {
            label: 'Low Severity',
            data: lowSeverity,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          },
          {
            label: 'Medium Severity',
            data: mediumSeverity,
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderColor: 'rgba(255, 193, 7, 1)',
            borderWidth: 1
          },
          {
            label: 'High Severity',
            data: highSeverity,
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Severity Indicators by Age and Duration'
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                return `Age: ${Math.round(context.parsed.x)}, Duration: ${Math.round(context.parsed.y)} days, Cases: ${Math.round(context.parsed.r)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Age'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Duration (days)'
            }
          }
        }
      }
    });
  }

  // Function to initialize trend numbers in the sidebar
  function initMiniCharts() {
    // This function now updates the number displays instead of creating charts
    updateTrendNumbers();
  }

  // Function to update trend numbers
  function updateTrendNumbers() {
    // Fetch the latest trend data from the server
    fetch('/dashboard/api/disease-trends/?days=7')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch trend data');
        }
        return response.json();
      })
      .then(data => {
        // Update the number displays with the latest data
        updateNumberDisplay('daily_cases', data.daily_cases || 20);
        updateNumberDisplay('hospitalizations', data.hospitalizations || 10);
        updateNumberDisplay('recoveries', data.recoveries || 18);
      })
      .catch(error => {
        console.error('Error updating trend numbers:', error);
        // Use default values if there's an error
        updateNumberDisplay('daily_cases', 20);
        updateNumberDisplay('hospitalizations', 10);
        updateNumberDisplay('recoveries', 18);
      });
  }

  // Helper function to update a number display
  function updateNumberDisplay(key, value) {
    // Find the display element by its parent's h6 text
    const headers = document.querySelectorAll('.card-body h6');
    for (const header of headers) {
      if (header.textContent.includes('Daily Cases') && key === 'daily_cases') {
        const display = header.nextElementSibling;
        if (display && display.tagName === 'H2') {
          display.textContent = value;
        }
      } else if (header.textContent.includes('Hospitalizations') && key === 'hospitalizations') {
        const display = header.nextElementSibling;
        if (display && display.tagName === 'H2') {
          display.textContent = value;
        }
      } else if (header.textContent.includes('Recoveries') && key === 'recoveries') {
        const display = header.nextElementSibling;
        if (display && display.tagName === 'H2') {
          display.textContent = value;
        }
      }
    }
  }

  // Function to create patient state chart
  function createPatientStateChart() {
    const ctx = document.getElementById('patientStateChart');
    if (!ctx) return;

    // Sample data for patient states
    const states = ['Active', 'Recovered', 'Critical', 'Deceased'];
    const counts = [45, 35, 15, 5];

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: states,
        datasets: [{
          data: counts,
          backgroundColor: [
            'rgba(255, 193, 7, 0.7)',
            'rgba(40, 167, 69, 0.7)',
            'rgba(220, 53, 69, 0.7)',
            'rgba(108, 117, 125, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12
            }
          }
        }
      }
    });
  }

  // Function to toggle chart type for disease type chart
  function toggleChartType(chartId, newType) {
    const chart = window[chartId];
    if (!chart) return;

    // Save current data
    const data = chart.data;

    // Destroy current chart
    chart.destroy();

    // Get canvas element
    const ctx = document.getElementById(chartId);

    // Create new chart with the same data but different type
    window[chartId] = new Chart(ctx, {
      type: newType,
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: newType === 'pie' ? 'right' : 'top'
          },
          title: {
            display: true,
            text: 'Disease Type Distribution'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            display: newType !== 'pie'
          },
          x: {
            display: newType !== 'pie'
          }
        }
      }
    });

    // Update button states
    document.querySelectorAll(`button[onclick*="${chartId}"]`).forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`button[onclick*="${chartId}, '${newType}'"]`).classList.add('active');
  }

  // Function to show/hide loading indicator
  function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
      loadingIndicator.style.display = show ? 'flex' : 'none';
    }
  }

  // Function to update all dashboard components with filtered data
  function updateDashboardCharts(data) {
    // If no data is provided, generate simulated data based on filters
    if (!data || Object.keys(data).length === 0) {
      data = generateFilteredDataBasedOnSelections();
    }

    // 1. Update KPI Cards (Total Cases, Active Cases, Recovered Cases, Critical Cases)
    updateKpiNumbers(data.kpi || {
      totalCases: getRandomInRange(39000, 48000),
      activeCases: getRandomInRange(18000, 24000),
      recoveredCases: getRandomInRange(9000, 12000),
      criticalCases: getRandomInRange(9000, 12000)
    });

    // 2. Update Disease Type Distribution Chart
    if (window.diseaseTypeChart) {
      const diseaseData = data.diseaseTypes || {
        labels: ['Respiratory', 'Cardiovascular', 'Gastrointestinal', 'Neurological', 'Other'],
        data: [
          getRandomInRange(250, 350),
          getRandomInRange(100, 200),
          getRandomInRange(75, 125),
          getRandomInRange(60, 100),
          getRandomInRange(30, 70)
        ]
      };
      window.diseaseTypeChart.data.labels = diseaseData.labels;
      window.diseaseTypeChart.data.datasets[0].data = diseaseData.data;
      window.diseaseTypeChart.update();
    }

    // 3. Update Age Group Analysis Chart
    const ageGroupChart = document.getElementById('ageGroupChart');
    if (ageGroupChart) {
      const chart = Chart.getChart(ageGroupChart);
      if (chart) {
        const ageData = data.ageGroups || {
          labels: ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70+'],
          maleCounts: [
            getRandomInRange(15, 25),
            getRandomInRange(25, 35),
            getRandomInRange(35, 45),
            getRandomInRange(45, 55),
            getRandomInRange(40, 50),
            getRandomInRange(30, 40),
            getRandomInRange(20, 30),
            getRandomInRange(10, 20)
          ],
          femaleCounts: [
            getRandomInRange(20, 30),
            getRandomInRange(30, 40),
            getRandomInRange(40, 50),
            getRandomInRange(50, 60),
            getRandomInRange(45, 55),
            getRandomInRange(35, 45),
            getRandomInRange(25, 35),
            getRandomInRange(15, 25)
          ]
        };
        chart.data.labels = ageData.labels;
        chart.data.datasets[0].data = ageData.maleCounts;
        chart.data.datasets[1].data = ageData.femaleCounts;
        chart.update();
      }
    }

    // 4. Update Monthly Comparison Chart
    const monthlyChart = document.getElementById('monthlyComparisonChart');
    if (monthlyChart) {
      const chart = Chart.getChart(monthlyChart);
      if (chart) {
        const monthlyData = data.monthlyComparison || {
          months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          year2023: [
            getRandomInRange(55, 75),
            getRandomInRange(50, 70),
            getRandomInRange(70, 90),
            getRandomInRange(70, 90),
            getRandomInRange(45, 65),
            getRandomInRange(45, 65)
          ],
          year2024: [
            getRandomInRange(20, 40),
            getRandomInRange(40, 60),
            getRandomInRange(30, 50),
            getRandomInRange(10, 30),
            getRandomInRange(75, 95),
            getRandomInRange(20, 40)
          ],
          year2025: [
            getRandomInRange(80, 100),
            getRandomInRange(110, 130),
            getRandomInRange(150, 170),
            getRandomInRange(180, 200),
            getRandomInRange(200, 220),
            getRandomInRange(240, 260)
          ]
        };
        chart.data.labels = monthlyData.months;
        chart.data.datasets[0].data = monthlyData.year2023;
        chart.data.datasets[1].data = monthlyData.year2024;
        chart.data.datasets[2].data = monthlyData.year2025;
        chart.update();
      }
    }

    // 5. Update Severity Indicators Chart
    const severityChart = document.getElementById('severityIndicatorsChart');
    if (severityChart) {
      const chart = Chart.getChart(severityChart);
      if (chart) {
        const severityData = data.severityIndicators || {};

        // Generate scatter data for each severity level based on filters
        const lowSeverity = severityData.lowSeverity || generateScatterData(20, 0, 100, 0, 30);
        const mediumSeverity = severityData.mediumSeverity || generateScatterData(15, 20, 120, 30, 60);
        const highSeverity = severityData.highSeverity || generateScatterData(10, 40, 140, 60, 100);

        chart.data.datasets[0].data = lowSeverity;
        chart.data.datasets[1].data = mediumSeverity;
        chart.data.datasets[2].data = highSeverity;
        chart.update();
      }
    }

    // 6. Update Patient State Chart
    const patientChart = document.getElementById('patientStateChart');
    if (patientChart) {
      const chart = Chart.getChart(patientChart);
      if (chart) {
        const patientData = data.patientStates || {
          labels: ['Active', 'Recovered', 'Critical', 'Deceased'],
          counts: [
            getRandomInRange(40, 50),
            getRandomInRange(30, 40),
            getRandomInRange(10, 20),
            getRandomInRange(3, 7)
          ]
        };
        chart.data.labels = patientData.labels;
        chart.data.datasets[0].data = patientData.counts;
        chart.update();
      }
    }

    // 7. Update Recent Trends
    updateRecentTrends(data.recentTrends || {
      daily_cases: getRandomInRange(18, 22),
      hospitalizations: getRandomInRange(8, 12),
      recoveries: getRandomInRange(16, 20)
    });

    // 8. Update all query charts
    updateQueryCharts(data.queries || {});

    // 9. Add filter status notification
    addFilterNotification();
  }

  // Function to update recent trend numbers
  function updateRecentTrends(trendData) {
    updateNumberDisplay('daily_cases', trendData.daily_cases || 20);
    updateNumberDisplay('hospitalizations', trendData.hospitalizations || 10);
    updateNumberDisplay('recoveries', trendData.recoveries || 18);
  }

  // Function to update all query charts
  function updateQueryCharts(queryData) {
    // Initialize People Query Chart with filtered data
    try {
      const peopleChartCtx = document.getElementById('peopleQueryChart');
      if (peopleChartCtx && peopleChartCtx.getContext('2d')) {
        // Use filtered data or fallback to default
        const peopleData = queryData.people || {
          labels: ['Under 18', '18-29', '30-44', '45-59', '60-74', '75+'],
          data: [8321, 5828, 7197, 7392, 7227, 7724].map(val => adjustValueBasedOnFilters(val))
        };

        // Update existing chart or create a new one
        const existingChart = Chart.getChart(peopleChartCtx);
        if (existingChart) {
          existingChart.data.labels = peopleData.labels;
          existingChart.data.datasets[0].data = peopleData.data;
          existingChart.update();
        } else {
          createStandardChart('peopleQueryChart', 'bar', peopleData.labels, peopleData.data, 'People by Age Groups');
        }
      }
    } catch (e) {
      console.error('Error updating people query chart:', e);
    }

    // Update Disease Query Chart with filtered data
    try {
      const diseaseChartCtx = document.getElementById('diseaseQueryChart');
      if (diseaseChartCtx && diseaseChartCtx.getContext('2d')) {
        // Use filtered data or fallback to default
        const diseaseData = queryData.diseases || {
          labels: ['COVID-19', 'E.Coli', 'Tuberculosis', 'Malaria', 'Influenza'],
          data: [8843, 8782, 8772, 8730, 8562].map(val => adjustValueBasedOnFilters(val))
        };

        // Update existing chart or create a new one
        const existingChart = Chart.getChart(diseaseChartCtx);
        if (existingChart) {
          existingChart.data.labels = diseaseData.labels;
          existingChart.data.datasets[0].data = diseaseData.data;
          existingChart.update();
        } else {
          createStandardChart('diseaseQueryChart', 'radar', diseaseData.labels, diseaseData.data, 'Disease Prevalence');
        }
      }
    } catch (e) {
      console.error('Error updating disease query chart:', e);
    }

    // Update Health Record Query Chart with filtered data
    try {
      const healthChartCtx = document.getElementById('healthRecordQueryChart');
      if (healthChartCtx && healthChartCtx.getContext('2d')) {
        // Use filtered data or fallback to default
        const healthData = queryData.healthRecords || {
          labels: ['High', 'Low', 'Medium'],
          data: [14655, 14571, 14463].map(val => adjustValueBasedOnFilters(val))
        };

        // Update existing chart or create a new one
        const existingChart = Chart.getChart(healthChartCtx);
        if (existingChart) {
          existingChart.data.labels = healthData.labels;
          existingChart.data.datasets[0].data = healthData.data;
          existingChart.update();
        } else {
          createStandardChart('healthRecordQueryChart', 'doughnut', healthData.labels, healthData.data, 'Health Records by Risk Level');
        }
      }
    } catch (e) {
      console.error('Error updating health record query chart:', e);
    }

    // Update Demographic Query Chart with filtered data
    try {
      const demoChartCtx = document.getElementById('demographicQueryChart');
      if (demoChartCtx && demoChartCtx.getContext('2d')) {
        // Use filtered data or fallback to default
        const demoData = queryData.demographics || {
          labels: ['18-29', '30-44', '45-59', '60-74', '75+', 'Under 18'],
          data: [5828, 7197, 7392, 7227, 7724, 8321].map(val => adjustValueBasedOnFilters(val))
        };

        // Update existing chart or create a new one
        const existingChart = Chart.getChart(demoChartCtx);
        if (existingChart) {
          existingChart.data.labels = demoData.labels;
          existingChart.data.datasets[0].data = demoData.data;
          existingChart.update();
        } else {
          createStandardChart('demographicQueryChart', 'doughnut', demoData.labels, demoData.data, 'Age Distribution - All Locations');
        }
      }
    } catch (e) {
      console.error('Error updating demographic query chart:', e);
    }
  }

  // Function to update KPI numbers based on filtered data
  function updateKpiNumbers(kpiData) {
    // Update total cases
    const totalCasesElement = document.querySelector('.bg-primary .mb-0');
    if (totalCasesElement && kpiData.totalCases) {
      totalCasesElement.textContent = kpiData.totalCases;
    }

    // Update active cases
    const activeCasesElement = document.querySelector('.bg-warning .mb-0');
    if (activeCasesElement && kpiData.activeCases) {
      activeCasesElement.textContent = kpiData.activeCases;
    }

    // Update recovered cases
    const recoveredCasesElement = document.querySelector('.bg-success .mb-0');
    if (recoveredCasesElement && kpiData.recoveredCases) {
      recoveredCasesElement.textContent = kpiData.recoveredCases;
    }

    // Update critical cases
    const criticalCasesElement = document.querySelector('.bg-danger .mb-0');
    if (criticalCasesElement && kpiData.criticalCases) {
      criticalCasesElement.textContent = kpiData.criticalCases;
    }
  }

  // Function to add filter notification
  function addFilterNotification() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const disease = document.getElementById('diseaseFilter').value;

    const filterStatus = document.createElement('div');
    filterStatus.className = 'alert alert-success mt-3';
    filterStatus.innerHTML = `<strong>Filters applied:</strong> Year=${year}, Month=${month}, Disease=${disease}`;

    // Add to the filter card
    const filterHeaders = document.querySelectorAll('.card-header');
    let filterCard;
    for (const header of filterHeaders) {
      if (header.textContent.includes('Filters')) {
        filterCard = header.closest('.card');
        break;
      }
    }

    const existingStatus = filterCard ? filterCard.querySelector('.alert') : null;
    if (existingStatus) {
      existingStatus.remove();
    }

    if (filterCard) {
      filterCard.appendChild(filterStatus);
    }
  }

  // Function to apply filters
  function applyFilters() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const disease = document.getElementById('diseaseFilter').value;

    console.log(`Applying filters: Year=${year}, Month=${month}, Disease=${disease}`);

    // Show loading indicator
    showLoading(true);

    // Create URL with filter parameters
    let url = '/dashboard/api/disease-trends/?';
    if (year !== 'all') url += `year=${year}&`;
    if (month !== 'all') url += `month=${month}&`;
    if (disease !== 'all') url += `disease=${disease}&`;

    // Fetch filtered data from the server
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch filtered data');
        }
        return response.json();
      })
      .then(data => {
        // Update all charts with filtered data
        updateDashboardCharts(data);
        showLoading(false);
      })
      .catch(error => {
        console.error('Error applying filters:', error);
        showLoading(false);

        // For demo purposes, simulate filtered data
        simulateFilteredData(year, month, disease);
      });
  }

  // Function to simulate filtered data for demo purposes
  function simulateFilteredData(year, month, disease) {
    // Generate filtered data based on the selected filters
    const filteredData = generateFilteredDataBasedOnSelections(year, month, disease);

    // Update all dashboard components with the filtered data
    updateDashboardCharts(filteredData);
  }

  // Generate random number in a range
  function getRandomInRange(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  // Adjust value based on selected filters
  function adjustValueBasedOnFilters(baseValue) {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const disease = document.getElementById('diseaseFilter').value;

    let multiplier = 1.0;

    // Adjust for year
    if (year === '2023') {
      multiplier *= 0.7; // Lower values for older years
    } else if (year === '2024') {
      multiplier *= 0.9;
    } else if (year === '2025') {
      multiplier *= 1.2; // Higher values for current year
    }

    // Adjust for month (more recent months might have more cases)
    if (month !== 'all') {
      const monthNum = parseInt(month);
      multiplier *= (0.8 + (monthNum / 12) * 0.4); // Values increase through the year
    }

    // Adjust for disease
    if (disease === 'covid19') {
      multiplier *= 1.3; // COVID-19 has more cases
    } else if (disease === 'influenza') {
      multiplier *= 0.9; // Fewer influenza cases
    } else if (disease === 'dengue') {
      multiplier *= 0.7; // Even fewer dengue cases
    }

    // Apply a small random variation
    multiplier *= (0.9 + Math.random() * 0.2);

    return Math.round(baseValue * multiplier);
  }

  // Generate complete filtered dataset based on filters
  function generateFilteredDataBasedOnSelections(year, month, disease) {
    const yearValue = year || document.getElementById('yearFilter').value;
    const monthValue = month || document.getElementById('monthFilter').value;
    const diseaseValue = disease || document.getElementById('diseaseFilter').value;

    console.log(`Generating data for: Year=${yearValue}, Month=${monthValue}, Disease=${diseaseValue}`);

    // Base multiplier based on filters
    let baseMultiplier = 1.0;

    // Adjust multiplier based on filters
    if (yearValue === '2023') baseMultiplier *= 0.8;
    if (yearValue === '2024') baseMultiplier *= 0.95;
    if (yearValue === '2025') baseMultiplier *= 1.15;

    if (monthValue !== 'all') {
      const monthNum = parseInt(monthValue);
      baseMultiplier *= (0.85 + (monthNum / 12) * 0.3);
    }

    if (diseaseValue === 'covid19') baseMultiplier *= 1.25;
    if (diseaseValue === 'influenza') baseMultiplier *= 0.9;
    if (diseaseValue === 'dengue') baseMultiplier *= 0.75;

    // Generate KPI data
    const totalCases = Math.round(43689 * baseMultiplier);
    const activeCases = Math.round(21370 * baseMultiplier);
    const recoveredCases = Math.round(10964 * baseMultiplier);
    const criticalCases = Math.round(10762 * baseMultiplier);

    // Return a complete dataset
    return {
      // KPI values
      kpi: {
        totalCases,
        activeCases,
        recoveredCases,
        criticalCases
      },

      // Disease type data
      diseaseTypes: {
        labels: ['Respiratory', 'Cardiovascular', 'Gastrointestinal', 'Neurological', 'Other'],
        data: [
          Math.round(300 * baseMultiplier),
          Math.round(150 * baseMultiplier),
          Math.round(100 * baseMultiplier),
          Math.round(80 * baseMultiplier),
          Math.round(50 * baseMultiplier)
        ]
      },

      // Age groups data
      ageGroups: {
        labels: ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70+'],
        maleCounts: [
          Math.round(20 * baseMultiplier),
          Math.round(30 * baseMultiplier),
          Math.round(40 * baseMultiplier),
          Math.round(50 * baseMultiplier),
          Math.round(45 * baseMultiplier),
          Math.round(35 * baseMultiplier),
          Math.round(25 * baseMultiplier),
          Math.round(15 * baseMultiplier)
        ],
        femaleCounts: [
          Math.round(25 * baseMultiplier),
          Math.round(35 * baseMultiplier),
          Math.round(45 * baseMultiplier),
          Math.round(55 * baseMultiplier),
          Math.round(50 * baseMultiplier),
          Math.round(40 * baseMultiplier),
          Math.round(30 * baseMultiplier),
          Math.round(20 * baseMultiplier)
        ]
      },

      // Monthly comparison data
      monthlyComparison: {
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        year2023: [
          Math.round(65 * baseMultiplier * 0.8),
          Math.round(59 * baseMultiplier * 0.8),
          Math.round(80 * baseMultiplier * 0.8),
          Math.round(81 * baseMultiplier * 0.8),
          Math.round(56 * baseMultiplier * 0.8),
          Math.round(55 * baseMultiplier * 0.8)
        ],
        year2024: [
          Math.round(28 * baseMultiplier * 0.95),
          Math.round(48 * baseMultiplier * 0.95),
          Math.round(40 * baseMultiplier * 0.95),
          Math.round(19 * baseMultiplier * 0.95),
          Math.round(86 * baseMultiplier * 0.95),
          Math.round(27 * baseMultiplier * 0.95)
        ],
        year2025: [
          Math.round(90 * baseMultiplier * 1.15),
          Math.round(120 * baseMultiplier * 1.15),
          Math.round(160 * baseMultiplier * 1.15),
          Math.round(190 * baseMultiplier * 1.15),
          Math.round(210 * baseMultiplier * 1.15),
          Math.round(250 * baseMultiplier * 1.15)
        ]
      },

      // Patient states data
      patientStates: {
        labels: ['Active', 'Recovered', 'Critical', 'Deceased'],
        counts: [
          Math.round(45 * baseMultiplier),
          Math.round(35 * baseMultiplier),
          Math.round(15 * baseMultiplier),
          Math.round(5 * baseMultiplier)
        ]
      },

      // Recent trends
      recentTrends: {
        daily_cases: Math.round(20 * baseMultiplier),
        hospitalizations: Math.round(10 * baseMultiplier),
        recoveries: Math.round(18 * baseMultiplier)
      },

      // Queries section data
      queries: {
        people: {
          labels: ['Under 18', '18-29', '30-44', '45-59', '60-74', '75+'],
          data: [
            Math.round(8321 * baseMultiplier),
            Math.round(5828 * baseMultiplier),
            Math.round(7197 * baseMultiplier),
            Math.round(7392 * baseMultiplier),
            Math.round(7227 * baseMultiplier),
            Math.round(7724 * baseMultiplier)
          ]
        },
        diseases: {
          labels: ['COVID-19', 'E.Coli', 'Tuberculosis', 'Malaria', 'Influenza'],
          data: [
            Math.round(8843 * baseMultiplier * (diseaseValue === 'covid19' ? 1.3 : 1)),
            Math.round(8782 * baseMultiplier),
            Math.round(8772 * baseMultiplier),
            Math.round(8730 * baseMultiplier),
            Math.round(8562 * baseMultiplier * (diseaseValue === 'influenza' ? 1.3 : 1))
          ]
        },
        healthRecords: {
          labels: ['High', 'Low', 'Medium'],
          data: [
            Math.round(14655 * baseMultiplier),
            Math.round(14571 * baseMultiplier),
            Math.round(14463 * baseMultiplier)
          ]
        },
        demographics: {
          labels: ['18-29', '30-44', '45-59', '60-74', '75+', 'Under 18'],
          data: [
            Math.round(5828 * baseMultiplier),
            Math.round(7197 * baseMultiplier),
            Math.round(7392 * baseMultiplier),
            Math.round(7227 * baseMultiplier),
            Math.round(7724 * baseMultiplier),
            Math.round(8321 * baseMultiplier)
          ]
        }
      }
    };
  }

  // Function to create a standard chart with common settings
  function createStandardChart(chartId, chartType, labels, data, title) {
    const ctx = document.getElementById(chartId);
    if (!ctx) return null;

    const standardColors = [
      'rgba(75, 192, 192, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(255, 99, 132, 0.7)',
      'rgba(153, 102, 255, 0.7)',
      'rgba(255, 159, 64, 0.7)',
      'rgba(201, 203, 207, 0.7)'
    ];

    return new Chart(ctx, {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: title,
          data: data,
          backgroundColor: standardColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function initQueryCharts() {
    // Initialize People Query Chart
    try {
      const peopleChartCtx = document.getElementById('peopleQueryChart');
      if (peopleChartCtx && peopleChartCtx.getContext('2d')) {
        // Get query data from the HTML data attributes
        // We'll use data attributes instead of Django template tags to avoid formatting issues
        const peopleHasFakeData = true; // Fallback when Django doesn't provide data

        // Sample data - in a real app, this would come from the Django context
        const labels = ['Under 18', '18-29', '30-44', '45-59', '60-74', '75+'];
        const data = [8321, 5828, 7197, 7392, 7227, 7724];

        createStandardChart('peopleQueryChart', 'bar', labels, data, 'People by Age Groups');
      }
    } catch (e) {
      console.error('Error initializing people query chart:', e);
    }

    // Initialize Disease Query Chart
    try {
      const diseaseChartCtx = document.getElementById('diseaseQueryChart');
      if (diseaseChartCtx && diseaseChartCtx.getContext('2d')) {
        // Sample data
        const labels = ['COVID-19', 'E.Coli', 'Tuberculosis', 'Malaria', 'Influenza'];
        const data = [8843, 8782, 8772, 8730, 8562];

        createStandardChart('diseaseQueryChart', 'radar', labels, data, 'Disease Prevalence');
      }
    } catch (e) {
      console.error('Error initializing disease query chart:', e);
    }

    // Initialize Health Record Query Chart
    try {
      const healthRecordChartCtx = document.getElementById('healthRecordQueryChart');
      if (healthRecordChartCtx && healthRecordChartCtx.getContext('2d')) {
        // Sample data
        const labels = ['High', 'Low', 'Medium'];
        const data = [14655, 14571, 14463];

        createStandardChart('healthRecordQueryChart', 'doughnut', labels, data, 'Health Records by Risk Level');
      }
    } catch (e) {
      console.error('Error initializing health record query chart:', e);
    }

    // Initialize Demographic Query Chart
    try {
      const demographicChartCtx = document.getElementById('demographicQueryChart');
      if (demographicChartCtx && demographicChartCtx.getContext('2d')) {
        // Sample data
        const labels = ['18-29', '30-44', '45-59', '60-74', '75+', 'Under 18'];
        const data = [5828, 7197, 7392, 7227, 7724, 8321];

        createStandardChart('demographicQueryChart', 'doughnut', labels, data, 'Age Distribution - All Locations');
      }
    } catch (e) {
      console.error('Error initializing demographic query chart:', e);
    }
  }
</script>
{% endblock %}